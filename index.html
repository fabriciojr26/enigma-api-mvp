<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controlo - Enigma API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
        }
        .number-box {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-radius: 0.5rem; /* Aumentar o arredondamento */
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.125rem;
            border: 2px solid transparent;
        }
        .number-box:not(.selected):not(.excluded):hover {
            transform: scale(1.05);
            background-color: #e5e7eb; /* Cinza mais claro no hover */
        }
        .number-box.selected { 
            background-color: #2563eb; 
            color: white; 
            border-color: #1d4ed8;
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.3);
        }
        .number-box.excluded { 
            background-color: #dc2626; 
            color: white; 
            border-color: #b91c1c;
            text-decoration: line-through;
            opacity: 0.7;
        }
        /* Spinner de Carregamento */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Painel de Controlo <span class="text-blue-600">Enigma</span></h1>
            <p class="text-lg text-gray-500 mt-2">Interface inteligente para a geração otimizada de combinações.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Coluna de Controlo -->
            <aside class="lg:col-span-4 xl:col-span-3 bg-white p-6 rounded-2xl shadow-lg space-y-8 h-fit">
                <div class="border-b border-gray-200 pb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Configurações</h2>
                    <div class="space-y-5 mt-5">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade de Bilhetes</label>
                            <input type="number" id="quantity" value="10" min="1" max="100" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                         <div>
                            <label for="tail_target" class="block text-sm font-medium text-gray-700 mb-1">Alvo Mínimo de Acertos (k)</label>
                            <select id="tail_target" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <option>11</option>
                                <option>12</option>
                                <option selected>13</option>
                                <option>14</option>
                                <option>15</option>
                            </select>
                        </div>
                    </div>
                </div>

                 <div>
                    <h3 class="text-xl font-semibold text-gray-800">Seleção de Números</h3>
                     <p class="text-sm text-gray-500 mt-2 mb-4">Clique para fixar (azul), clique de novo para excluir (vermelho), e um terceiro clique para limpar.</p>
                    <div id="number-grid" class="number-grid">
                        <!-- Números serão gerados por JavaScript -->
                    </div>
                </div>

                <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105 duration-300 shadow-lg">
                    <span id="btn-text">Gerar Bilhetes</span>
                </button>
            </aside>

            <!-- Coluna de Resultados -->
            <section class="lg:col-span-8 xl:col-span-9">
                <div id="initial-state" class="flex flex-col items-center justify-center bg-white p-8 rounded-2xl shadow-lg h-full text-center">
                    <svg class="w-16 h-16 text-gray-300 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
                    <h2 class="text-2xl font-semibold text-gray-700">Os seus bilhetes aparecerão aqui.</h2>
                    <p class="text-gray-500 mt-2">Ajuste as configurações e clique em "Gerar Bilhetes" para começar.</p>
                </div>
                <div id="loading" class="hidden flex-col items-center justify-center bg-white p-8 rounded-2xl shadow-lg h-full">
                    <div class="spinner"></div>
                    <p class="text-lg font-medium text-gray-600 mt-4">A otimizar combinações, por favor aguarde...</p>
                </div>
                 <div id="error" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-lg" role="alert">
                    <strong class="font-bold">Ocorreu um Erro!</strong>
                    <p id="error-message" class="mt-2"></p>
                </div>
                <div id="results" class="hidden bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-3xl font-bold text-gray-800 mb-5">Resultados da Geração</h2>
                    <div id="meta-info" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center"></div>
                    <div id="games-list" class="space-y-3"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const numberGrid = document.getElementById('number-grid');
            const generateBtn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            
            const initialStateDiv = document.getElementById('initial-state');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const errorMessageSpan = document.getElementById('error-message');
            const resultsDiv = document.getElementById('results');
            const metaInfoDiv = document.getElementById('meta-info');
            const gamesListDiv = document.getElementById('games-list');

            let fixedNumbers = [];
            let excludedNumbers = [];

            for (let i = 1; i <= 25; i++) {
                const box = document.createElement('div');
                box.textContent = i;
                box.dataset.number = i;
                box.className = 'number-box bg-gray-100 border-gray-200';
                box.addEventListener('click', () => toggleNumberState(box, i));
                numberGrid.appendChild(box);
            }
            
            function toggleNumberState(box, number) {
                const isSelected = fixedNumbers.includes(number);
                const isExcluded = excludedNumbers.includes(number);

                if (!isSelected && !isExcluded) { // Livre -> Fixo
                    box.classList.add('selected');
                    fixedNumbers.push(number);
                } else if (isSelected) { // Fixo -> Excluído
                    box.classList.remove('selected');
                    box.classList.add('excluded');
                    fixedNumbers = fixedNumbers.filter(n => n !== number);
                    excludedNumbers.push(number);
                } else { // Excluído -> Livre
                    box.classList.remove('excluded');
                    excludedNumbers = excludedNumbers.filter(n => n !== number);
                }
            }

            generateBtn.addEventListener('click', async () => {
                initialStateDiv.classList.add('hidden');
                loadingDiv.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                generateBtn.disabled = true;
                btnText.textContent = "A Gerar...";
                
                const requestBody = {
                    quantity: parseInt(document.getElementById('quantity').value, 10),
                    mode: "AUTO",
                    objective: "TAIL",
                    tail_target: parseInt(document.getElementById('tail_target').value, 10),
                    advanced: {
                        fixed_numbers: fixedNumbers.length > 0 ? fixedNumbers : null,
                        excluded_numbers: excludedNumbers.length > 0 ? excludedNumbers : null
                    }
                };

                try {
                    const response = await fetch('http://127.0.0.1:8000/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail?.[0]?.msg || errorData.detail || `HTTP error! Status: ${response.status}`);
                    }

                    const data = await response.json();
                    displayResults(data);

                } catch (error) {
                    displayError(error.message);
                } finally {
                    loadingDiv.classList.add('hidden');
                    generateBtn.disabled = false;
                    btnText.textContent = "Gerar Bilhetes";
                }
            });
            
            function displayError(message) {
                errorMessageSpan.textContent = `Não foi possível comunicar com o servidor. Verifique se ele está a funcionar e tente novamente. Detalhe técnico: ${message}`;
                errorDiv.classList.remove('hidden');
            }

            function displayResults(data) {
                metaInfoDiv.innerHTML = '';
                gamesListDiv.innerHTML = '';

                const metaItems = {
                    "Run ID": data.run_id.substring(4, 14),
                    "Versão": data.engine_version,
                    "Objetivo": data.objective_used,
                    "P(Acerto ≥ k)": data.meta.p_success_ge_k ? (data.meta.p_success_ge_k * 100).toFixed(2) + '%' : 'N/A'
                };
                
                for(const [key, value] of Object.entries(metaItems)) {
                    metaInfoDiv.innerHTML += `
                        <div class="bg-gray-50 p-3 rounded-xl">
                            <p class="text-sm text-gray-500 font-medium">${key}</p>
                            <p class="font-bold text-xl text-gray-800">${value}</p>
                        </div>
                    `;
                }

                data.games.forEach(game => {
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'p-3 bg-gray-50 rounded-xl flex items-center space-x-4 transition-all hover:bg-gray-100 hover:shadow-sm';
                    
                    let numbersHtml = game.numbers.map(n => {
                        let classes = 'w-9 h-9 flex items-center justify-center rounded-full font-bold text-sm shadow-inner ';
                        if (fixedNumbers.includes(n)) {
                            classes += 'bg-blue-600 text-white ring-2 ring-blue-300';
                        } else {
                            classes += 'bg-white text-gray-700';
                        }
                        return `<div class="${classes}">${n}</div>`;
                    }).join('');

                    gameDiv.innerHTML = `
                        <div class="font-bold text-gray-400 text-lg w-8 text-center">#${game.id.toString().padStart(2, '0')}</div>
                        <div class="flex flex-wrap gap-2">${numbersHtml}</div>
                    `;
                    gamesListDiv.appendChild(gameDiv);
                });

                resultsDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>

